import React, { useState, useRef, useEffect } from 'react';
import { Sparkles } from 'lucide-react';

const RandomWheel = () => {
  const [items, setItems] = useState(['치킨', '치즈', '사과', '콜', '햄버거', '라면', '김밥', '햇반', '피자', '초밥', '떡볶이']);
  const [rotation, setRotation] = useState(0);
  const [isSpinning, setIsSpinning] = useState(false);
  const [newItem, setNewItem] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [menuToDelete, setMenuToDelete] = useState('');
  const [showFireworks, setShowFireworks] = useState(false);
  const [selectedIndex, setSelectedIndex] = useState(null);
  const [screenSize, setScreenSize] = useState({ width: window.innerWidth, height: window.innerHeight });
  const wheelRef = useRef(null);
  
  // 화면 크기 변경 감지
  useEffect(() => {
    const handleResize = () => {
      setScreenSize({ width: window.innerWidth, height: window.innerHeight });
    };
    
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  
  // 모바일 환경인지 확인
  const isMobile = screenSize.width < 768;
  
  const colors = [
    '#9932CC', '#DC143C', '#FF4500', '#FFA500', 
    '#FFD700', '#32CD32', '#008B8B', '#483D8B'
  ];
  
  const handleAddItem = () => {
    if (newItem.trim() !== '') {
      setItems([...items, newItem]);
      setNewItem('');
    }
  };
  
  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleAddItem();
    }
  };
  
  const handleDeleteItem = () => {
    if (menuToDelete.trim() !== '') {
      const updatedItems = items.filter(item => item !== menuToDelete);
      if (updatedItems.length === items.length) {
        alert('해당 메뉴가 목록에 없습니다.');
      } else {
        setItems(updatedItems);
        setMenuToDelete('');
      }
    }
  };
  
  const handleDeleteKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleDeleteItem();
    }
  };
  
  const spinWheel = () => {
    if (isSpinning) return;
    
    setIsSpinning(true);
    setSelectedItem(null);
    setSelectedIndex(null);
    setShowFireworks(false);
    
    // 랜덤한 회전 각도 (5-10 회전)
    const spinAngle = 1800 + Math.random() * 1800;
    // 회전각을 0에서 시작하는 새로운 각도로 설정
    const newRotation = spinAngle;
    setRotation(newRotation);
    
    // 회전이 끝난 후 선택된 항목 계산
    setTimeout(() => {
      const degreesPerItem = 360 / items.length;
      // 포인터는 위에 있으므로 회전 각도에서 항목을 계산
      const normalizedRotation = newRotation % 360;
      // 각도에서 선택된 항목의 인덱스 계산 (시계 방향으로 회전하므로 특별한 계산 필요)
      const index = Math.floor(((360 - normalizedRotation) % 360) / degreesPerItem);
      setSelectedIndex(index);
      setSelectedItem(items[index]);
      setShowFireworks(true);
      
      // 3초 후에 폭죽 효과 제거
      setTimeout(() => {
        setShowFireworks(false);
      }, 3000);
      
      setIsSpinning(false);
    }, 3000);
  };
  
  // SVG 휠 생성
  const generateWheel = () => {
    const total = items.length;
    const degreesPerItem = 360 / total;
    
    return items.map((item, index) => {
      const startAngle = index * degreesPerItem;
      const endAngle = (index + 1) * degreesPerItem;
      
      const startRadians = (startAngle * Math.PI) / 180;
      const endRadians = (endAngle * Math.PI) / 180;
      
      const r = 150; // 반지름
      
      const x1 = r * Math.sin(startRadians);
      const y1 = -r * Math.cos(startRadians);
      const x2 = r * Math.sin(endRadians);
      const y2 = -r * Math.cos(endRadians);
      
      // 텍스트 위치 계산 (각 구역의 중앙)
      const midAngle = (startAngle + endAngle) / 2;
      const midRadians = (midAngle * Math.PI) / 180;
      const textR = r * 0.65; // 텍스트는 중심에서 65% 거리에 배치
      const textX = textR * Math.sin(midRadians);
      const textY = -textR * Math.cos(midRadians);
      
      const largeArcFlag = degreesPerItem > 180 ? 1 : 0;
      
      const pathData = `M 0 0 L ${x1} ${y1} A ${r} ${r} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
      
      // 선택된 항목 하이라이트
      const isSelected = selectedIndex === index && !isSpinning;
      const fillColor = isSelected 
        ? "#FFD700" // 골드 색상으로 하이라이트
        : colors[index % colors.length];
      
      const strokeWidth = isSelected ? 3 : 1;
      const strokeColor = isSelected ? "#FF4500" : "#ffffff";
      
      // 모바일 환경에서는 폰트 크기를 조정
      const fontSize = isMobile 
        ? (isSelected ? "14" : "12") 
        : (isSelected ? "16" : "14");
      
      // 텍스트가 너무 길면 줄임
      let displayText = item;
      if (isMobile && item.length > 6) {
        displayText = item.substring(0, 5) + '..';
      }
      
      return (
        <g key={index}>
          <path 
            d={pathData} 
            fill={fillColor} 
            stroke={strokeColor} 
            strokeWidth={strokeWidth}
          />
          <text 
            x={textX} 
            y={textY}
            fill={isSelected ? "#000000" : "#ffffff"}
            fontWeight="bold"
            fontSize={fontSize}
            textAnchor="middle"
            alignmentBaseline="middle"
            transform={`rotate(${midAngle}, ${textX}, ${textY})`}
          >
            {displayText}
          </text>
        </g>
      );
    });
  };
  
  return (
    <div className="flex flex-col items-center justify-center p-4 max-w-xl mx-auto">
      {/* 모바일 레이아웃 - 입력 필드와 버튼을 수직으로 배치 */}
      {isMobile ? (
        <>
          <div className="w-full mb-2">
            <input
              type="text"
              className="border border-gray-300 rounded-t p-2 w-full"
              placeholder="이름 입력"
              value={newItem}
              onChange={(e) => setNewItem(e.target.value)}
              onKeyPress={handleKeyPress}
            />
            <button
              className="bg-black text-white p-2 rounded-b w-full"
              onClick={handleAddItem}
            >
              추가
            </button>
          </div>
          
          <div className="w-full mb-4">
            <input
              type="text"
              className="border border-gray-300 rounded-t p-2 w-full"
              placeholder="삭제할 메뉴 입력"
              value={menuToDelete}
              onChange={(e) => setMenuToDelete(e.target.value)}
              onKeyPress={handleDeleteKeyPress}
            />
            <button
              className="bg-red-500 text-white p-2 rounded-b w-full"
              onClick={handleDeleteItem}
            >
              삭제
            </button>
          </div>
        </>
      ) : (
        // 데스크톱 레이아웃 - 기존 가로 배치
        <>
          <div className="w-full flex mb-4">
            <input
              type="text"
              className="border border-gray-300 rounded-l p-2 flex-1"
              placeholder="이름 입력"
              value={newItem}
              onChange={(e) => setNewItem(e.target.value)}
              onKeyPress={handleKeyPress}
            />
            <button
              className="bg-black text-white px-4 py-2 rounded-r"
              onClick={handleAddItem}
            >
              추가
            </button>
          </div>
          
          <div className="w-full flex mb-4">
            <input
              type="text"
              className="border border-gray-300 rounded-l p-2 flex-1"
              placeholder="삭제할 메뉴 입력"
              value={menuToDelete}
              onChange={(e) => setMenuToDelete(e.target.value)}
              onKeyPress={handleDeleteKeyPress}
            />
            <button
              className="bg-red-500 text-white px-4 py-2 rounded-r"
              onClick={handleDeleteItem}
            >
              삭제
            </button>
          </div>
        </>
      )}
      
      <div className="relative w-full max-w-md mb-4">
        {/* 포인터 삼각형 */}
        <div 
          className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10"
          style={{ 
            width: '0', 
            height: '0', 
            borderLeft: isMobile ? '8px solid transparent' : '10px solid transparent',
            borderRight: isMobile ? '8px solid transparent' : '10px solid transparent',
            borderTop: isMobile ? '16px solid black' : '20px solid black' 
          }}
        />
        
        {/* 휠 */}
        <div className="relative">
          <svg 
            ref={wheelRef}
            viewBox="-150 -150 300 300"
            className="w-full h-full"
            style={{ 
              transform: `rotate(${rotation}deg)`,
              transition: isSpinning ? 'transform 3s cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none'
            }}
          >
            {generateWheel()}
          </svg>
        </div>
      </div>
      
      <button
        className={`${isMobile ? 'w-full p-3 text-lg' : 'px-6 py-2'} bg-black text-white rounded mb-4 ${isSpinning ? 'opacity-50' : 'opacity-100'}`}
        onClick={spinWheel}
        disabled={isSpinning}
      >
        {isSpinning ? '돌리는 중...' : '돌려!'}
      </button>
      
      {selectedItem && (
        <div className={`${isMobile ? 'text-xl' : 'text-2xl'} font-bold mt-4 flex items-center justify-center flex-wrap`}>
          <span className="mr-2">선택된 메뉴:</span>
          <span className="text-red-500">{selectedItem}</span>
          {showFireworks && (
            <div className="flex mt-1">
              <Sparkles className="text-yellow-500 ml-2" size={isMobile ? 24 : 32} />
              <Sparkles className="text-red-500 ml-1" size={isMobile ? 18 : 24} />
              <Sparkles className="text-blue-500 ml-1" size={isMobile ? 22 : 28} />
            </div>
          )}
        </div>
      )}
      
      {showFireworks && (
        <div className="fixed inset-0 pointer-events-none">
          <div className="absolute top-1/4 left-1/4 animate-ping">
            <Sparkles size={isMobile ? 32 : 48} className="text-yellow-500" />
          </div>
          <div className="absolute top-1/3 right-1/4 animate-ping delay-100">
            <Sparkles size={isMobile ? 24 : 36} className="text-red-500" />
          </div>
          <div className="absolute bottom-1/3 left-1/3 animate-ping delay-200">
            <Sparkles size={isMobile ? 28 : 42} className="text-blue-500" />
          </div>
          <div className="absolute top-1/2 right-1/3 animate-ping delay-300">
            <Sparkles size={isMobile ? 26 : 38} className="text-green-500" />
          </div>
          <div className="absolute bottom-1/4 right-1/3 animate-ping delay-400">
            <Sparkles size={isMobile ? 30 : 44} className="text-purple-500" />
          </div>
        </div>
      )}
      
      {/* 모바일 화면용 메뉴 리스트 */}
      {isMobile && (
        <div className="mt-4 w-full">
          <details className="bg-gray-100 rounded p-2">
            <summary className="font-bold cursor-pointer">현재 메뉴 목록 보기</summary>
            <ul className="mt-2 pl-4">
              {items.map((item, idx) => (
                <li key={idx} className={selectedIndex === idx ? "text-red-500 font-bold" : ""}>
                  {item}
                </li>
              ))}
            </ul>
          </details>
        </div>
      )}
    </div>
  );
};

export default RandomWheel;
